"""
RSI Indicator - Mojo 0.26.2 Implementation
Optimized for Trading Chitti intraday scanner
"""

from math import sqrt


fn rsi(prices: List[Float64], period: Int = 14) raises -> List[Float64]:
  """Calculate Relative Strength Index (RSI).

  Args:
    prices: List of price values.
    period: Number of periods (default 14).

  Returns:
    List of RSI values (0-100).
  """
  var n = len(prices)
  var result = List[Float64](capacity=n)

  # Initialize result list with zeros
  for _ in range(n):
    result.append(0.0)

  if period <= 0 or period >= n:
    return result^

  # Calculate price changes
  var gains = List[Float64](capacity=n-1)
  var losses = List[Float64](capacity=n-1)

  for i in range(1, n):
    var change = prices[i] - prices[i - 1]
    if change > 0:
      gains.append(change)
      losses.append(0.0)
    else:
      gains.append(0.0)
      losses.append(-change)

  # Calculate initial average gain/loss
  var avg_gain: Float64 = 0.0
  var avg_loss: Float64 = 0.0

  for i in range(period):
    avg_gain += gains[i]
    avg_loss += losses[i]

  avg_gain /= Float64(period)
  avg_loss /= Float64(period)

  # Calculate RSI for first period
  if avg_loss == 0:
    result[period] = 100.0
  else:
    var rs = avg_gain / avg_loss
    result[period] = 100.0 - (100.0 / (1.0 + rs))

  # Calculate RSI for remaining periods using smoothed averages
  for i in range(period + 1, n):
    avg_gain = (avg_gain * Float64(period - 1) + gains[i - 1]) / Float64(period)
    avg_loss = (avg_loss * Float64(period - 1) + losses[i - 1]) / Float64(period)

    if avg_loss == 0:
      result[i] = 100.0
    else:
      var rs = avg_gain / avg_loss
      result[i] = 100.0 - (100.0 / (1.0 + rs))

  return result^


fn ema(prices: List[Float64], period: Int) raises -> List[Float64]:
  """Calculate Exponential Moving Average (EMA).

  Args:
    prices: List of price values.
    period: Number of periods for EMA.

  Returns:
    List of EMA values.
  """
  var n = len(prices)
  var result = List[Float64](capacity=n)

  # Initialize result list with zeros
  for _ in range(n):
    result.append(0.0)

  if period <= 0 or period > n:
    return result^

  # Calculate multiplier: 2 / (period + 1)
  var multiplier = 2.0 / Float64(period + 1)

  # Start with SMA for first value
  var sum: Float64 = 0.0
  for i in range(period):
    sum += prices[i]
  var initial_ema = sum / Float64(period)
  result[period - 1] = initial_ema

  # Calculate EMA: EMA = (Close - EMA_prev) * multiplier + EMA_prev
  var prev_ema = initial_ema
  for i in range(period, n):
    var current_ema = (prices[i] - prev_ema) * multiplier + prev_ema
    result[i] = current_ema
    prev_ema = current_ema

  return result^


fn sma(prices: List[Float64], period: Int) raises -> List[Float64]:
  """Calculate Simple Moving Average (SMA).

  Args:
    prices: List of price values.
    period: Number of periods.

  Returns:
    List of SMA values.
  """
  var n = len(prices)
  var result = List[Float64](capacity=n)

  # Initialize with zeros
  for _ in range(n):
    result.append(0.0)

  if period <= 0 or period > n:
    return result^

  # Calculate first SMA value
  var sum: Float64 = 0.0
  for i in range(period):
    sum += prices[i]
  result[period - 1] = sum / Float64(period)

  # Calculate remaining SMA values using sliding window
  for i in range(period, n):
    sum = sum - prices[i - period] + prices[i]
    result[i] = sum / Float64(period)

  return result^


fn main():
  """Test the indicators with sample data."""
  print("üî• Testing Mojo RSI Indicator...")

  try:
    # Sample price data (30 days)
    var prices = List[Float64]()
    for i in range(30):
      prices.append(100.0 + Float64(i) * 0.5 + Float64(i % 3) * 2.0)

    print("\nüìä Sample price data (first 10 days):")
    for i in range(10):
      print("  Day", i, ":", prices[i])

    # Test RSI
    print("\nüìà RSI (period=14):")
    var rsi_result = rsi(prices, 14)
    print("  Total values:", len(rsi_result))
    print("  Last 5 RSI values:")
    for i in range(max(0, len(rsi_result) - 5), len(rsi_result)):
      if rsi_result[i] > 0:
        print("    Day", i, ":", rsi_result[i])

    # Test EMA
    print("\nüìà EMA (period=9):")
    var ema_result = ema(prices, 9)
    print("  Last 5 EMA values:")
    for i in range(max(0, len(ema_result) - 5), len(ema_result)):
      if ema_result[i] > 0:
        print("    Day", i, ":", ema_result[i])

    # Test SMA
    print("\nüìà SMA (period=5):")
    var sma_result = sma(prices, 5)
    print("  Last 5 SMA values:")
    for i in range(max(0, len(sma_result) - 5), len(sma_result)):
      if sma_result[i] > 0:
        print("    Day", i, ":", sma_result[i])

    print("\n‚úÖ All indicators compiled and working!")
    print("üìä Performance: Mojo is ready for integration")

  except e:
    print("‚ùå Error:", e)
