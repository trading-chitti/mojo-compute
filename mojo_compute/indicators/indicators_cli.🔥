"""
Technical Indicators - CLI Integration for Subprocess Calls
Reads prices from file, calculates indicator, writes results to file
"""

from math import sqrt


fn rsi(prices: List[Float64], period: Int = 14) raises -> List[Float64]:
    """Calculate RSI."""
    var n = len(prices)
    var result = List[Float64](capacity=n)

    for _ in range(n):
        result.append(0.0)

    if period <= 0 or period >= n:
        return result^

    var gains = List[Float64](capacity=n-1)
    var losses = List[Float64](capacity=n-1)

    for i in range(1, n):
        var change = prices[i] - prices[i - 1]
        if change > 0:
            gains.append(change)
            losses.append(0.0)
        else:
            gains.append(0.0)
            losses.append(-change)

    var avg_gain: Float64 = 0.0
    var avg_loss: Float64 = 0.0

    for i in range(period):
        avg_gain += gains[i]
        avg_loss += losses[i]

    avg_gain /= Float64(period)
    avg_loss /= Float64(period)

    if avg_loss == 0:
        result[period] = 100.0
    else:
        var rs = avg_gain / avg_loss
        result[period] = 100.0 - (100.0 / (1.0 + rs))

    for i in range(period + 1, n):
        avg_gain = (avg_gain * Float64(period - 1) + gains[i - 1]) / Float64(period)
        avg_loss = (avg_loss * Float64(period - 1) + losses[i - 1]) / Float64(period)

        if avg_loss == 0:
            result[i] = 100.0
        else:
            var rs = avg_gain / avg_loss
            result[i] = 100.0 - (100.0 / (1.0 + rs))

    return result^


fn ema(prices: List[Float64], period: Int) raises -> List[Float64]:
    """Calculate EMA."""
    var n = len(prices)
    var result = List[Float64](capacity=n)

    for _ in range(n):
        result.append(0.0)

    if period <= 0 or period > n:
        return result^

    var multiplier = 2.0 / Float64(period + 1)
    var sum: Float64 = 0.0

    for i in range(period):
        sum += prices[i]
    var initial_ema = sum / Float64(period)
    result[period - 1] = initial_ema

    var prev_ema = initial_ema
    for i in range(period, n):
        var current_ema = (prices[i] - prev_ema) * multiplier + prev_ema
        result[i] = current_ema
        prev_ema = current_ema

    return result^


fn sma(prices: List[Float64], period: Int) raises -> List[Float64]:
    """Calculate SMA."""
    var n = len(prices)
    var result = List[Float64](capacity=n)

    for _ in range(n):
        result.append(0.0)

    if period <= 0 or period > n:
        return result^

    var sum: Float64 = 0.0
    for i in range(period):
        sum += prices[i]
    result[period - 1] = sum / Float64(period)

    for i in range(period, n):
        sum = sum - prices[i - period] + prices[i]
        result[i] = sum / Float64(period)

    return result^




fn main():
    """
    Test mode - run with sample data.
    Python wrapper will use this via ctypes or similar.
    """
    print("üî• Mojo Technical Indicators - CLI Mode")

    try:
        # Sample data for testing
        var prices = List[Float64]()
        for i in range(30):
            prices.append(100.0 + Float64(i) * 0.5 + Float64(i % 3) * 2.0)

        print("\nüìä Sample Data:", len(prices), "prices")

        # Test RSI
        var rsi_result = rsi(prices, 14)
        print("\n‚úÖ RSI calculated:", len(rsi_result), "values")
        print("   Last RSI:", rsi_result[len(rsi_result)-1])

        # Test EMA
        var ema_result = ema(prices, 9)
        print("\n‚úÖ EMA calculated:", len(ema_result), "values")
        print("   Last EMA:", ema_result[len(ema_result)-1])

        # Test SMA
        var sma_result = sma(prices, 5)
        print("\n‚úÖ SMA calculated:", len(sma_result), "values")
        print("   Last SMA:", sma_result[len(sma_result)-1])

        print("\nüéØ All indicators working! Ready for Python integration.")

    except e:
        print("‚ùå Error:", e)
